---
layout: post
title: '스프링부트 공부'
date: 2020-12-17 13:00:59
author: mollangzzang
categories: TIL
tags: TIL
cover: '/assets/TIL.png'
---

아직까지 만든 서비스는 애플리케이션을 재시작하면 로그인이 풀리는데, 그 이유는 세션이 **내장 톰캣의 메모리에 저장**되기 때문이다.

기본적으로 세션은 실행되는 WAS의 메모리에 저장되고 호출된다. 메모리에 저장되다보니 내장 톰캣처럼 애플리케이션 실행 시 실행되는 구조에선 항상 초기화가 된다.

즉, **배포할 때마다 톰캣이 재시작**된다는 것이다.
또한 2대 이상의 서버에서 서비스하고 있다면 톰캣마다 세션 동기화 설정을 해주어야한다. 따라서 현업에는 아래와 같은 3가지 방법 중 한가지를 선택한다고 한다.

1. 톰캣 세션을 사용한다.

- 일반적으로 별다른 설정을 하지 않을 때 기본적으로 사용되는 방식이다.
- 이 때 톰캣(WAS)에 세션이 저장되기에 2대 이상의 WAS가 구동되는 환경에서는 톰캣들 간의 세션 공유를 위한 추가 설정이 필요하다.

2. MySQL과 같은 데이터베이스를 세션 저장소로 사용한다.

- 여러 WAS간의 공용 세션을 사용할 수 있는 가장 쉬운 방법
- 많은 설정이 필요없지만, 결국 로그인 요청마다 DB IO이 발생하여 성능상 이슈가 발생한다.
- 보통 로그인 요청이 많이 없는 백 오피스, 사내 시스템 용도에서 사용된다.

3. Redis, Memcached와 같은 메모리 DB를 세션 저장소로 사용한다.

- B2C 서비스에서 가장 많이 사용하는 방식이다.
- 실제 서비스로 사용하기 위해서는 Embedded Redis와 같은 방식이 아닌 외부 메모리 서버가 필요하다.

## 시큐리티 적용 후 테스트

기존에는 바로 API를 호출할 수 있어서 테스트 코드 역시 바로 API를 호출하도록 구현하였다. 하지만 시큐리티 옵션이 활성화되면 인증된 사용자만 API를 호출할 수 있기에 테스트 코드마다 인증한 사용자가 호출한 것처럼 수정해주어야 한다.

test를 실행해보면 롬복을 이용한 테스트를 제외하면 기존에 작성한 코드들이 실패하게 되는데, 이는 test가 main의 설정을 가져오는 것에서 비롯된다.

test에 `application.properties`가 없다면 main의 설정을 가져오지만 여기까지가 한계이고 `application-oauth.properties` 와 같은 파일은 가져오지 못한다.
따라서 각자의 환경을 따로 구성해주어야 해결이 가능하다.

## 24시간 동작하는 서버

- 집에 PC를 24시간 구동시킨다.
- 호스팅 서비스 (Cafe 24, 코리아 호스팅 등)을 이용한다.
- 클라우드 서비스 (AWS, AZURE, GCP) 등을 이용한다.

## AWS 서버 생성 시 해야할 것

- Java 설치

- 타임존 변경
  - 기존 서버의 시간은 미국 시간대라서, 한국 시간대로 바꿔야 한다.
- 호스트네임 변경
  - 현재 접속한 서버의 별명을 지어줘야 한다. 실수에서는 한대의 서버가 아닌 수십대의 서버가 작동되는데, IP만으로 어떤 서버가 어떠한 역할을 하는지 모르기 때문이다.

## 추가적으로 공부해야할 키워드

데이터베이스를 직접 설치해서 다루게 된다면 모니터링, 알람, 백업, HA 구성등을 모두 직접 해야 한다고 한다. 이 부분에 대해서 추가적으로 공부하자.
